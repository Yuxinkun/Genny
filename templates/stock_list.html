{% extends "mybase.html" %}
{% load static %}
{% load staticfiles %}
{% block title %}Welcome Stock Trading System{% endblock %}

{% block content %}

    <section class="content-header">

    </section>

    <section class="content">
        <div class="box">
            <div class="box-header">
                <h3 class="box-title">Stock Information List</h3>
                <div class="box-header ">
                </div>

                <div class="box-body">
                    <table id="stock_table" class="table table-bordered table-striped">
                        <thead>
                        <tr>
                            <th>Stock Code</th>
                            <th>Name</th>
                            <th>Issue Date</th>
                            <th>Prev Close Price</th>
                            <th>Opening Price</th>
                            <th>Type</th>
                            <th>Board</th>
                            <th>Change</th>
                            <th>Details</th>
                        </tr>
                        </thead>
                        <tbody>

                        {% for item in stock %}
                            {% if item.change_extent > 0 %}
                                <tr style="color: red">
                                    <td>{{ item.stock_id }}</td>
                                    <td>{{ item.stock_name }}</td>
                                    <td>{{ item.issuance_time }}</td>
                                    <td>{{ item.closing_price_y }}</td>
                                    <td>{{ item.open_price_t }}</td>
                                    <td>{{ item.stock_type }}</td>
                                    <td>{{ item.block }}</td>
                                    <td>{{ item.change_extent }}</td>
                                    <td style="vertical-align: middle">
                                        <a href="{% url 'tradingSystem:stock_info' item.stock_id %}">detail</a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr style="color: green">
                                    <td>{{ item.stock_id }}</td>
                                    <td>{{ item.stock_name }}</td>
                                    <td>{{ item.issuance_time }}</td>
                                    <td>{{ item.closing_price_y }}</td>
                                    <td>{{ item.open_price_t }}</td>
                                    <td>{{ item.stock_type }}</td>
                                    <td>{{ item.block }}</td>
                                    <td>{{ item.change_extent }}</td>
                                    <td style="vertical-align: middle">
                                        <a href="{% url 'tradingSystem:stock_info' item.stock_id %}">detail</a>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
               <div class="row">

            <div class="col-md-12">
                {#                <div class="box box-solid bg-teal-gradien">#}
                <div class="box box-solid">
                    <div class="box-header">
                        <i class="fa fa-th"></i>

                        <h3 class="box-title">Trending Stocks</h3>

                        <div class="box-tools pull-right">
                          <div class="dropdown">
                            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenu" data-toggle="dropdown">
                              S&P 500 INDEX
                              <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenu">
                              <li><a href="#" data-chart="dataset1">S&P 500 INDEX</a></li>
                              <li><a href="#" data-chart="dataset2">Hang Sang Index</a></li>
                              <li><a href="#" data-chart="dataset3">Nikkei 225 Index</a></li>
                              <li><a href="#" data-chart="dataset4">NASDAQ Composite Index</a></li>
                            </ul>
                          </div>
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="stock-chart" style="height:500px;"></div>
                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer no-border">
                        {% comment %}
                        <div class="row">

                            <div class="col-xs-4 text-center" style="border-right: 1px solid #f4f4f4">
                                <input type="text" class="knob" data-readonly="true" value="20" data-width="60"
                                       data-height="60"
                                       data-fgColor="#39CCCC">

                                <div class="knob-label">Mail-Orders</div>
                            </div>

                            <!-- ./col -->
                            <div class="col-xs-4 text-center" style="border-right: 1px solid #f4f4f4">
                                <input type="text" class="knob" data-readonly="true" value="50" data-width="60"
                                       data-height="60"
                                       data-fgColor="#39CCCC">

                                <div class="knob-label">Online</div>
                            </div>
                            <!-- ./col -->
                            <div class="col-xs-4 text-center">
                                <input type="text" class="knob" data-readonly="true" value="30" data-width="60"
                                       data-height="60"
                                       data-fgColor="#39CCCC">

                                <div class="knob-label">In-Store</div>
                            </div>
                            <!-- ./col -->
                        </div>
                        {% endcomment %}
                        <!-- /.row -->
                    </div>
                    <!-- /.box-footer -->
                </div>
            </div>

            <!-- <div class="col-md-4">            
                <div class="box box-success">
                </div>           
            </div> -->
        </div>
        <div class="row">
        </div>

    </section>
{% endblock %}
{% block script %}
    <script src="{% static 'AdminLTE/plugins/echarts.js' %}"></script>
    <script src="{% static 'data/marketData.js' %}"></script>
    <script>

        $(function () {
            $(".select2").select2();
        });
        $(function () {
            var table = $('#stock_table').DataTable({
                dom: 'Bfrtip',
                buttons: [],
                "paging": true, 
                "lengthChange": true, 
                "searching": true, 
                "ordering": true, 
                "info": true, 
                "autoWidth": false, 
                "language": {
                    "sProcessing": "being processed...",
                    "sLengthMenu": "The _MENU_ item results are displayed",
                    "sZeroRecords": "No match result",
                    "sInfo": "The results of items from _START_ to _END_ are displayed. _TOTAL_ items are displayed",
                    "sInfoEmpty": "The results of items from 0 to 0 are displayed. 0 items are displayed",
                    "sInfoFiltered": "(Filtered by _MAX_ results)",
                    "sInfoPostFix": "",
                    "sSearch": "Search:",
                    "sUrl": "",
                    "sEmptyTable": "Data in the table is empty",
                    "sLoadingRecords": "Loading...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "Home",
                        "sPrevious": "Pre",
                        "sNext": "Next",
                        "sLast": "End"
                    },
                    "oAria": {
                        "sSortAscending": ": ascending order",
                        "sSortDescending": ": descending order"
                    }
                },
                "columnDefs": [{
                    "searchable": false,
                    "orderable": true,
                    "targets": 0
                }],
                "order": [[0, 'asc']]
            });

            $('#stock_table').on('click', 'tr', function (e) {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                } else {
                    table.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }
            });

            $('.select2').select2();
        });


        $(document).ready(function () {

//            $(".name").click

            var currentDataset = chartData.dataset1;
            /*基于准备好的dom，初始化echarts实例*/
            var myChart = echarts.init(document.getElementById('stock-chart'));

            // 数据意义：开盘(open)，收盘(close)，最低(lowest)，最高(highest)
            

            //计算MA平均线，N日移动平均线=N日收盘价之和/N  dayCount要计算的天数(5,10,20,30)
            function calculateMA(dayCount) {
                var result = [];
                for (var i = 0, len = currentDataset.data.values.length; i < len; i++) {
                    if (i < dayCount) {
                        result.push('-');
                        //alert(result);
                        continue;   //结束单次循环，即不输出本次结果
                    }
                    var sum = 0;
                    for (var j = 0; j < dayCount; j++) {
                        //收盘价总和
                        sum += currentDataset.data.values[i - j][1];
                        //alert(sum);
                    }
                    result.push(sum / dayCount);
                    // alert(result);
                }
                return result;
            }


            function getOption (dataset) {
            return {
              title: {    //标题
                text: dataset.titel,
                left: 0
              },
              tooltip: {  //提示框
                trigger: 'axis',    //触发类型：坐标轴触发
                axisPointer: {  //坐标轴指示器配置项
                  type: 'cross'   //指示器类型，十字准星
                }
              },
              legend: {   //图例控件，点击图例控制哪些系列不现实
                data: ['MA', 'MA5', 'MA10', 'MA20', 'MA30']
              },
              grid: {     //直角坐标系
                show: true,
                left: '5%',    //grid组件离容器左侧的距离
                right: '10%',
                bottom: '5%',
                //backgroundColor:'#ccc'
              },
              xAxis: {
                type: 'category',   //坐标轴类型，类目轴
                data: dataset.data.categoryData,
                //scale: true,  //只在数字轴中有效
                boundaryGap: false,    //刻度作为分割线，标签和数据点会在两个刻度上
                axisLine: { onZero: false },
                splitLine: { show: false },   //是否显示坐标轴轴线
                //splitNumber: 20,    //坐标轴的分割段数，预估值，在类目轴中无效
                min: 'dataMin', //特殊值，数轴上的最小值作为最小刻度
                max: 'dataMax'  //特殊值，数轴上的最大值作为最大刻度
              },
              yAxis: {
                scale: true,    //坐标刻度不强制包含零刻度
                splitArea: {
                  show: true  //显示分割区域
                }
              },
              dataZoom: [     //用于区域缩放
                {
                  filterMode: 'filter',    //当前数据窗口外的数据被过滤掉来达到数据窗口缩放的效果  默认值filter
                  type: 'inside', //内置型数据区域缩放组件
                  start: 50,      //数据窗口范围的起始百分比
                  end: 100        //数据窗口范围的结束百分比
                },
                {
                  show: true,
                  type: 'slider', //滑动条型数据区域缩放组件
                  y: '90%',
                  start: 50,
                  end: 100
                }
              ],
              series: [   //图表类型
                {
                  name: 'MA',
                  type: 'candlestick',    //K线图
                  data: dataset.data.values,     //y轴对应的数据

                  ////////////////////////图标标注/////////////////////////////

                  markPoint: {    //图表标注
                    label: {    //标注的文本
                      normal: {   //默认不显示标注
                        show: true,
                        //position:['20%','30%'],
                        formatter: function (param) {   //标签内容控制器
                          return param != null ? Math.round(param.value) : '';
                        }
                      }
                    },
                    data: [     //标注的数据数组
                      {
                        name: 'XX标点',
                        coord: ['2013/5/31', 2300], //指定数据的坐标位置
                        value: 2300,
                        itemStyle: {    //图形样式
                          normal: { color: 'rgb(41,60,85)' }
                        }
                      },
                      {
                        name: 'highest value',
                        type: 'max',    //最大值
                        valueDim: 'highest'     //在highest维度上的最大值 最高价
                      },
                      {
                        name: 'lowest value',
                        type: 'min',
                        valueDim: 'lowest'  //最低价
                      },
                      {
                        name: 'average value on close',
                        type: 'average',
                        valueDim: 'close'   //收盘价
                      }
                    ],
                    tooltip: {      //提示框
                      formatter: function (param) {
                        return param.name + '<br>' + (param.data.coord || '');
                      }
                    }
                  },

                  /////////////////////////////////图标标线///////////////////////////

                  markLine: {
                    symbol: ['none', 'none'],   //标线两端的标记类型
                    data: [
                      [
                        {
                          name: 'from lowest to highest',
                          type: 'min',    //设置该标线为最小值的线
                          valueDim: 'lowest', //指定在哪个维度上的最小值
                          symbol: 'circle',
                          symbolSize: 10, //起点标记的大小
                          label: {    //normal默认，emphasis高亮
                            normal: { show: false },  //不显示标签
                            emphasis: { show: false } //不显示标签
                          }
                        },
                        {
                          type: 'max',
                          valueDim: 'highest',
                          symbol: 'circle',
                          symbolSize: 10,
                          label: {
                            normal: { show: false },
                            emphasis: { show: false }
                          }
                        }
                      ],

                      {
                        name: 'min line on close',
                        type: 'min',
                        valueDim: 'close'
                      },
                      {
                        name: 'max line on close',
                        type: 'max',
                        valueDim: 'close'
                      }
                    ]

                  }

                },
                {   //MA5 5天内的收盘价之和/5
                  name: 'MA5',
                  type: 'line',
                  data: calculateMA(5),
                  smooth: true,
                  lineStyle: {
                    normal: { opacity: 0.5 }
                  }
                },
                {
                  name: 'MA10',
                  type: 'line',
                  data: calculateMA(10),
                  smooth: true,
                  lineStyle: {    //标线的样式
                    normal: { opacity: 0.5 }
                  }
                },
                {
                  name: 'MA20',
                  type: 'line',
                  data: calculateMA(20),
                  smooth: true,
                  lineStyle: {
                    normal: { opacity: 0.5 }
                  }
                },
                {
                  name: 'MA30',
                  type: 'line',
                  data: calculateMA(30),
                  smooth: true,
                  lineStyle: {
                    normal: { opacity: 0.5 }
                  }
                },

              ]
            };
          }
            // 使用刚指定的配置项和数据显示图表
          myChart.setOption(getOption(currentDataset));
          // 设置改变大小重绘窗口
          window.addEventListener("resize", function () {
              myChart.resize();
          });
          function updateChart (dataset) {
            currentDataset = chartData[dataset];
            console.log("11", currentDataset)
            myChart.setOption(getOption(currentDataset));
          }

          // 下拉菜单点击事件
          $('.dropdown-menu a').click(function () {
            var selectedDataset = $(this).data('chart');
            updateChart(selectedDataset);
            $('#dropdownMenu').text($(this).text()).append(' <span class="caret"></span>');
          });
        });

    </script>
{% endblock %}